"use strict";function PastacEditProductController(e,o,t,r,i){function n(e,r,i){var n="//"+TEASERVICE_HOST+":"+TEASERVICE_PORT+"/v3/12345/productSpecifications",a={product_variant_id:e.product_variant_id,category_specification_type_id:r.category_specification_type_id};switch(r.data_type){case"TXT":a.text=i;break;case"INT":a.int=i;break;case"DEC":a.dec=i;break;case"OPT":a.category_specification_option_id=i}t({method:"POST",url:n,headers:{"access-token":"0613952f81da9b3d0c9e4e5fab123437",version:"2.0.0"},data:a}).then(function(e){o(function(){g.errmsg=null},3e3)},p)}function a(o,t,i){console.log("loadProduct:",t);var n={withReferences:!0,where:{product_id:t}};TooltwistViews.select(g.teaContext,h,n,function(o,t,i){if(o)return void console.log("Error selecting view "+h,o);w=i,console.log("PRODUCT_METADATA=",i),console.log("data=",t),console.log("metadata=",i),g.product=t.length>0?t[0]:null,g.viewLabel=i.label,g.handler&&g.handler.onLoadProduct&&g.handler.onLoadProduct(g.product),g.ckeditorOptions={language:"en"},g.ckeditorOptions.toolbarGroups=[{name:"clipboard",groups:["clipboard","undo"]},{name:"editing",groups:["find","selection","spellchecker","editing"]},{name:"links",groups:["links"]},{name:"insert",groups:["insert"]},{name:"forms",groups:["forms"]},{name:"tools",groups:["tools"]},{name:"document",groups:["mode","document","doctools"]},{name:"others",groups:["others"]},{name:"basicstyles",groups:["basicstyles","cleanup"]},{name:"paragraph",groups:["list","indent","blocks","align","bidi","paragraph"]},{name:"styles",groups:["styles"]},{name:"colors",groups:["colors"]},{name:"about",groups:["about"]}],g.ckeditorOptions.removeButtons="Underline,Subscript,Superscript,Strike,Maximize,Image,Table,HorizontalRule,SpecialChar,Link,Unlink,Anchor,Scayt,PasteFromWord,PasteText,Source,Styles,Format,About,Blockquote";var n={listModel:"supplier2_list",listTableClasses:"table-condensed table-hover",listClickFunction:"supplier2_listClick",recordScope:"ctrl",recordModel:"product"},a=$("#supplier2_recordDiv"),c=TooltwistViews.fieldsForMode(i,"record"),l=TooltwistViews.htmlForAngular_edit(i,c,n);console.log("html=",l),a.html(l),r(a)(e),console.log("WARNING, Commission rate should only be editable by admin");var a=$("#supplier2_adminDiv"),c=TooltwistViews.fieldsForMode(i,"admin"),l=TooltwistViews.htmlForAngular_edit(i,c,n);a.html(l),r(a)(e),console.log("Set record:",g.product),g.headingForRecordPane=g.product?g.product.name:"",s(e,g.teaContext,g.product.product_id)})}function c(e){console.log("loadCategoriesForProduct("+e+")");var o={};TooltwistViews.select(g.teaContext,T,o,function(o,t,r){if(o)return void console.log("Error selecting view "+T,o);S=r,console.log("Loaded all categories",t),g.categories=t,g.categories.sort(function(e,o){var t=e.name.toUpperCase(),r=o.name.toUpperCase();return"OTHER"==t&&(t="Z"),"OTHER"==r&&(r="Z"),t<r?-1:t>r?1:0});var i={withReferences:!0,where:{product_id:e}};TooltwistViews.select(g.teaContext,I,i,function(e,o,t){if(e)return void console.log("Error selecting view "+I,e);R=t,g.categoryTags=[],o.forEach(function(e){g.categories.forEach(function(o){o.category_id==e.category_id&&g.categoryTags.push({category_id:o.category_id,text:o.name})})})})})}function s(e,o,r){console.log("loadVariantsForProduct("+r+")");var i={withReferences:!0,where:{product_id:g.product.product_id}};TooltwistViews.select(o,m,i,function(e,r,i){if(e)return void console.log("Error selecting view "+m,e);if(S=i,g.variants=r,console.log("product_variant data=",r),console.log("product_variant metadata=",i),0==g.variants.length){alert("Creating initial variant for this product");var n={product_id:g.product.product_id,is_deleted:0,name:g.product.name,components_qty:1,is_featured_product:0,is_free:0,is_approved:0};TooltwistViews.save(g.teaContext,S,"record",g.product,function(e,r){if(console.log("save returned",e,r),e)return void console.log("Error saving view "+S+"/record",e);n.product_variant_id=r.data.newId,g.variants=[n],n._productVariantImage_list=[],n._productPricing_list=[],u(t,o,n)})}g.variants.forEach(function(e){d(e),l(e),u(t,o,e)}),g.handler&&g.handler.onLoadVariants&&g.handler.onLoadVariants(r)})}function l(e){var o={where:{product_variant_id:e.product_variant_id,scope:"V"}};TooltwistViews.select(g.teaContext,v,o,function(o,t,r){if(o)return void console.log("Error selecting view "+v,o);V=r,console.log("pricing data=",t),e._productPricing_list=t;var i="",n="";e._productPricing_list.forEach(function(e){"BRKQTY"==e.type&&(i+=n+e.pricing_id,n=",",e._pricingQty=[])}),""!=i&&TooltwistViews.select(g.teaContext,E,{where:{pricing_id:i}},function(o,t,r){if(o)return void console.log("Error selecting view "+E,o);C=r,console.log("pricing_quantity selected",t),t.forEach(function(o){e._productPricing_list.forEach(function(e){e.pricing_id==o.pricing_id&&e._pricingQty.push(o)})})})})}function d(o){TooltwistViews.select(g.teaContext,y,{withReferences:!1,where:{product_variant_id:o.product_variant_id}},function(t,i,n){if(t)return void console.log("Error selecting view "+y,t);P=n,o._productVariantImage_list=[];var a=null;i.forEach(function(e){if(e.image_path){console.log("++++++++++\n++++++++++\n++++++++++\n",e);if(e.image_path.startsWith("cloudinary")){console.log("IS CLOUDINARY IMAGE"),null==a&&(a=cloudinary.Cloudinary.new({cloud_name:CLOUDINARY_CLOUD_NAME}));var t=e.image_path.substring("cloudinary:".length),r=t+".jpg";e._cloudinaryImage_raw=a.url(r),e._cloudinaryImage_lowquality=a.url(r,{width:200,effect:"blur:600",opacity:50,crop:"scale"}),e._cloudinaryImage_320=a.url(r,{width:320,crop:"limit"}),e._cloudinaryImage_480=a.url(r,{width:480,crop:"limit"}),e._cloudinaryImage_768=a.url(r,{width:768,crop:"limit"}),e._cloudinaryImage_992=a.url(r,{width:992,crop:"limit"}),e._cloudinaryImage_1200=a.url(r,{width:1200,crop:"limit"}),e._cloudinaryImage_1920=a.url(r,{width:1920,crop:"limit"}),e._512x512=a.url(r,{width:512,height:512,crop:"fit"}),e._thumbnail=a.url(r,{width:200,height:200,crop:"fit"}),e._raw=a.url(r);var i=e.image_size/1024;e._size=accounting.formatNumber(i)+" kb"}else e._512x512=e.image_path,e._thumbnail=e.image_path,e._raw=e.image_path,e._size=null;o._productVariantImage_list.push(e)}}),o._productVariantImage_list.sort(function(e,o){console.log("image1=",e);var t=e.sort_id?e.sort_id:0,r=o.sort_id?o.sort_id:0;return t<r?-1:t>r?1:0}),o._selectedImage=o._productVariantImage_list.length>0?o._productVariantImage_list[0]:null;for(var c=0;c<o._productVariantImage_list.length;c++){var s=o._productVariantImage_list[c];if(s.is_displayed){o._selectedImage=s;break}}var l={listModel:"productVariantImage_list"},d=TooltwistViews.fieldsForMode(n,"list"),u=TooltwistViews.htmlForAngular_list(n,d,l),p=$("#productVariantImage_listDiv");p.html(u),r(p)(e)})}function u(e,o,t){console.log("loadSpecTypesOptionsAndValuesForVariant()");var r="//"+TEASERVICE_HOST+":"+TEASERVICE_PORT+"/v3/12345/productSpecifications/"+t.product_variant_id,i={product_variant_id:t.product_variant_id};console.log("URL="+r),console.log("PARAMS=",i),e({method:"GET",url:r,headers:{"access-token":"0613952f81da9b3d0c9e4e5fab123437",version:"2.0.0"},data:i}).then(function(e){t._specTypesOptionsAndValues=e.data,t._specTypesOptionsAndValues.categories.forEach(function(e){e.category_specification_types.forEach(function(e){if(e.current_value)switch(e.data_type){case"TXT":e._currentValue=e.current_value.text;break;case"INT":e._currentValue=e.current_value.int;break;case"DEC":e._currentValue=e.current_value.dec;break;case"OPT":e.options.forEach(function(o){o.category_specification_option_id==e.current_value.category_specification_option_id&&(e._selectedOption=o)})}})})},p)}function p(e){g.inProgress=!1,console.log("--------------------------------"),console.log("Error calling TEAservice:"),console.log(" Response=",e),console.log("--------------------------------");var o="Error calling server";if(e.data&&e.data.code&&e.data.message)var o="Error: "+e.data.code+": "+e.data.message;else if(e.statusText)var o="Error: "+e.statusText;else var o="Error: "+e.status;g.errmsg="Error calling server.",g.errmsg=o}function _(e){console.log("saveProductImageOrderAndIsDisplayed()");var o={product_variant_id:e.product_variant_id,images:[]};e._productVariantImage_list.forEach(function(e){o.images.push({product_variant_image_id:e.product_variant_image_id,is_displayed:e.is_displayed})}),console.log("params=",o);var r="//"+TEASERVICE_HOST+":"+TEASERVICE_PORT+"/v3/12345/productImageOrder";console.log("URL="+r),console.log("PARAMS=",o),t({method:"POST",url:r,headers:{"access-token":"0613952f81da9b3d0c9e4e5fab123437",version:"2.0.0"},data:o}).then(function(e){console.log("Response is",e)},p)}var g=this,f=null;const h="product",m="product_variant",v="pricing",E="pricing_quantity",y="product_variant_image",T="category",I="product_categories";var w=null,S=null,V=null,C=null,P=null,R=null;g.teaContext={$scope:e,$http:t,$timeout:o,$compile:r,TEASERVICE_HOST:TEASERVICE_HOST,TEASERVICE_PORT:TEASERVICE_PORT,TEASERVICE_VERSION:TEASERVICE_VERSION,TEASERVICE_ACCESS_TOKEN:TEASERVICE_ACCESS_TOKEN,STORE_ID:6},g.$onInit=function(){},g.$onChanges=function(e){console.log("changed",e);g.handler&&g.handler.onAddSupplier&&g.handler.onAddSupplier;g.productId!=f&&(console.log("SupplierId has changed"),f=g.productId,a(g.jwt,g.productId,null),c(g.productId))},g.doProductButton=function(e){g.handler&&g.handler.onProductButton&&g.handler.onProductButton(e)},g.doVariantButton=function(e,o){g.handler&&g.handler.onVariantButton&&g.handler.onVariantButton(e,o)},g.doSave=function(){console.log("doSave()"),TooltwistViews.save(g.teaContext,w,"record",g.product,function(e,o){if(console.log("save returned",e,o),e)return void console.log("Error saving view "+h+"/record",e);!function e(o){if(!(o>=g.variants.length)){var t=g.variants[o];console.log("Save variant "+o+":",t),TooltwistViews.save(g.teaContext,S,"record",t,function(t,r){if(console.log("save returned",t,r),t)return void console.log("Error saving view "+m+"/record",t);setTimeout(function(){e(o+1)},1)})}}(0)})},g.doSelectProduct=function(e){console.log("ctrl.selectProduct()"),g.handler&&g.handler.onSelectProduct&&g.handler.onSelectProduct(e.productId)},g.doSelectSpecificationOption=function(e,o,t){console.log("doSelectSpecificationOption()"),console.log("specificationType=",t),console.log("selectedOption=",t._selectedOption),n(e,t,t._selectedOption.category_specification_option_id),e._specTypesOptionsAndValues.categories.forEach(function(r){r.category_id!=o.category_id&&r.category_specification_types.forEach(function(o){o.specification_type_id==t.specification_type_id&&o.options.forEach(function(r){r.value==t._selectedOption.value&&(o._selectedOption=r,n(e,o,r.category_specification_option_id))})})})},g.doSetSpecificationValue=function(e,o,t){console.log("doSetSpecificationValue()"),console.log("specificationType=",t),console.log("selectedOption=",t._currentValue);var r=t._currentValue;n(e,t,r),e._specTypesOptionsAndValues.categories.forEach(function(i){i.category_id!=o.category_id&&i.category_specification_types.forEach(function(o){o.specification_type_id==t.specification_type_id&&(o._currentValue=t._currentValue,n(e,o,r))})})},g.loadCategoryTags=function(e){var o=[];return e=e.toUpperCase().trim(),g.categories.forEach(function(t){t.name.toUpperCase().indexOf(e)>=0&&o.push({category_id:t.category_id,text:t.name})}),o},g.doRemoveCategory=function(e){var o="//"+TEASERVICE_HOST+":"+TEASERVICE_PORT+"/v3/delProductCategory",r={product_id:g.productId,category_id:e.category_id};t({method:"POST",url:o,headers:{"access-token":"0613952f81da9b3d0c9e4e5fab123437",version:"2.0.0"},data:r}).then(function(e){g.variants.forEach(function(e){u(t,g.teaContext,e)})},p)},g.doAddCategory=function(e){var o="//"+TEASERVICE_HOST+":"+TEASERVICE_PORT+"/v3/putProductCategory",r={product_id:g.productId,category_id:e.category_id};t({method:"POST",url:o,headers:{"access-token":"0613952f81da9b3d0c9e4e5fab123437",version:"2.0.0"},data:r}).then(function(e){g.variants.forEach(function(e){u(t,g.teaContext,e)})},p)},g.doUploadImage=function(e,t){console.log("doUploadImage()");var r="//"+TEASERVICE_HOST+":"+TEASERVICE_PORT+"/v3/"+TEASERVICE_APIKEY+"/productImage",n={product_variant_id:e.product_variant_id};console.log("url is "+r),console.log("data is ",n),console.log("file is ",t),t&&(g.filesize=accounting.formatNumber(t.size),g.filename=t.name,n.file=t,i.upload({url:r,headers:{"access-token":"0613952f81da9b3d0c9e4e5fab123437",version:"2.0.0"},data:n}).then(function(t){console.log("resp: ",t),console.log("Success "+t.config.data.file.name+"uploaded. Response: "+t.data),o(function(){g.message="",g.file=null,g.progressPercentage=null,d(e)},1)},function(e){console.log("Error status: "+e.status)},function(e){console.log("evt=",e);var t=parseInt(100*e.loaded/e.total);console.log("progress: "+t+"% "+e.config.data.file.name),o(function(){g.progressPercentage=t},1)}))},g.cancelPost=function(){g.file=null,g.progressPercentage=null},g.haveFile=function(){return!!g.file},g.showDropArea=function(){return!g.file},g.showImage=function(){return!!e.file},g.showProgressBar=function(){return g.file&&g.progressPercentage&&g.progressPercentage<100},g.showProcessing=function(){return g.file&&g.progressPercentage&&100==g.progressPercentage},g.getPercentage=function(){return g.progressPercentage},g.doToggleIsDisplayed=function(e,o){1==o.is_displayed?o.is_displayed=0:o.is_displayed=1,_(e)},g.doSetAsDefaultProductImage=function(e,o){var t=0,r=[];o&&(e._selectedImage=o,o.is_displayed=1,o.sort_id=t++,r.push(o)),e._productVariantImage_list.forEach(function(e){e!=o&&(e.sort_id=t++,r.push(e))}),e._productVariantImage_list=r,_(e)},g.doSelectImage=function(e,o){e._selectedImage=o},g.addPricingQty=function(e,o){var t={pricing_id:o.pricing_id,quantity:2,price:e.last_price,shared_sale_ok:1,multiple_addresses_ok:1};try{o._pricingQty.forEach(function(e){e.price<t.price&&(t.price=e.price),parseInt(e.quantity)>parseInt(t.quantity)&&(t.quantity=e.quantity+5)})}catch(e){}o._pricingQty.push(t)},g.addPricing_BRKQTY=function(e){var o={code:"",product_variant_id:e.product_variant_id,quantity:1,scope:"V",status:"A",store_id:STORE_ID,type:"BRKQTY",_pricingQty:[{quantity:2,price:e.last_price,shared_sale_ok:1,multiple_addresses_ok:1}]};console.log("new pricing record",o),e._productPricing_list.push(o)}}angular.module("pastac-edit-product",[]).component("pastacEditProduct",{controller:PastacEditProductController,controllerAs:"ctrl",bindings:{handler:"<",jwt:"<",productId:"<",productButton:"@",variantButton:"@",template:"@"},templateUrl:function(e,o){var t="/bower_components/pastac-edit-product/dist/pastac-edit-product.html";return o.template&&(t=o.template),t}});